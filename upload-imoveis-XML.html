<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Upload e Processamento de XML</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #logs { border: 1px solid #ccc; background: #f0f0f0; height: 300px; overflow-y: scroll; padding: 10px; white-space: pre-wrap; margin-top: 15px; }
        progress { width: 100%; height: 25px; }
    </style>
</head>
<body>
    <h1>Processar XML de Imóveis no Frontend</h1>
    <form id="uploadForm">
        <input type="file" id="xmlFile" accept=".xml">
        <button type="submit">Iniciar Processamento</button>
    </form>

    <h3 id="status" style="display: none;">Progresso:</h3>
    <progress id="progressBar" value="0" max="100" style="display: none;"></progress>
    <div id="logs" style="display: none;"></div>

    <script>
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('xmlFile');
        const logsDiv = document.getElementById('logs');
        const progressBar = document.getElementById('progressBar');
        const statusHeader = document.getElementById('status');

        // --- NOVA FUNÇÃO DE PAUSA ---
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!fileInput.files.length) {
                alert('Selecione um arquivo XML');
                return;
            }
            
            logsDiv.innerHTML = '';
            statusHeader.style.display = 'block';
            logsDiv.style.display = 'block';
            progressBar.style.display = 'block';
            progressBar.value = 0;

            const file = fileInput.files[0];
            const fileContent = await file.text();
            
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(fileContent, "application/xml");

            const listings = xmlDoc.querySelectorAll('Listing');
            const total = listings.length;
            progressBar.max = total;

            addLog(`Arquivo lido. Total de ${total} imóveis encontrados.`);

            let count = 0;
            for (const listingNode of listings) {
                count++;
                
                // --- APLICA A PAUSA AQUI ---
                const tempoDePausa = 500 + Math.random() * 1000; // Pausa entre 0.5 e 1.5 segundos
                addLog(`Aguardando ${tempoDePausa.toFixed(0)}ms...`);
                await delay(tempoDePausa);
                // -------------------------

                addLog(`Processando imóvel ${count} de ${total} (ID: ${getText(listingNode, 'ListingID')})...`);
                
                const imovelData = extrairDadosDoImovel(listingNode);

                try {
                    const response = await fetch('https://api.personal-dev.online/imovel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(imovelData)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    addLog(` -> Resposta: ${result.message}`);
                } catch (error) {
                    addLog(` -> ERRO: ${error.message}`);
                    // Adicione um 'break' se quiser parar o loop em caso de erro
                    // break; 
                }
                progressBar.value = count;
            }
            addLog('--- Processamento Concluído! ---');
        });

        function addLog(message) {
            logsDiv.innerHTML += message + '\n';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // As funções getText, getAttribute e extrairDadosDoImovel continuam iguais...
        function getText(node, tagName) {
            const element = node.querySelector(tagName);
            return element ? element.textContent.trim() : null;
        }
        function getAttribute(node, tagName, attribute) {
            const element = node.querySelector(tagName);
            return element ? element.getAttribute(attribute) : null;
        }
        function extrairDadosDoImovel(node) {
            return {
                listing_id: getText(node, 'ListingID'),
                titulo: getText(node, 'Title'),
                tipo_transacao: getText(node, 'TransactionType'),
                tipo_imovel: getText(node, 'PropertyType'),
                descricao: getText(node, 'Description'),
                preco: parseFloat(getText(node, 'ListPrice')) || 0,
                moeda: getAttribute(node, 'ListPrice', 'currency') || 'BRL',
                quartos: parseInt(getText(node, 'Bedrooms')) || 0,
                banheiros: parseInt(getText(node, 'Bathrooms')) || 0,
                suites: parseInt(getText(node, 'Suites')) || 0,
                garagem: parseInt(getText(node, 'Garage')) || 0,
                area: parseFloat(getText(node, 'LivingArea')) || 0,
                unidade_area: getAttribute(node, 'LivingArea', 'unit') || 'square metres',
                pais: getText(node, 'Country'),
                estado: getAttribute(node, 'State', 'abbreviation'),
                cidade: getText(node, 'City'),
                bairro: getText(node, 'Neighborhood'),
                endereco: getText(node, 'Address'),
                numero: getText(node, 'StreetNumber'),
                complemento: getText(node, 'Complement'),
                cep: getText(node, 'PostalCode'),
                url_imagem_principal: node.querySelector('Item[primary="true"]')?.textContent.trim()
            };
        }
    </script>
</body>
</html>